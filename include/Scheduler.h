#pragma once

#include <QList>
#include <QDateTime>
#include "Card.h"
#include "Deck.h"

/**
 * @brief Класс-планировщик для системы интервального повторения
 *
 * Класс Scheduler реализует алгоритмы планирования повторений карточек.
 * Все методы являются статическими, так как класс представляет собой
 * утилитарный набор функций без состояния.
 *
 * Основные функции:
 * 1. Обновление состояния карточки по алгоритму SM2
 * 2. Фильтрация карточек, готовых к повторению
 *
 * @note Все методы потокобезопасны (thread-safe)
 * @see https://www.supermemo.com/en/archives1990-2015/english/ol/sm2
 *
 * @author bozvan
 * @version 1.0
 */
class Scheduler
{
public:
    /**
     * @brief Обновить карточку по алгоритму SM2 (SuperMemo 2)
     *
     * Алгоритм SM2 для интервального повторения:
     * - Оценка (grade) от 0 до 5 определяет качество ответа
     * - При grade < 3: сброс прогресса, интервал = 1 день
     * - При grade ≥ 3: увеличение интервала по формуле
     * - Easy Factor (EF) обновляется и ограничивается [1.3, 2.5]
     * - Устанавливаются даты lastReview и nextReview
     *
     * @param card Карточка для обновления (модифицируется)
     * @param grade Оценка ответа (0-5)
     *              0: Полный провал
     *              1: Очень плохо
     *              2: Плохо
     *              3: Удовлетворительно
     *              4: Хорошо
     *              5: Отлично
     *
     * @note Grade автоматически ограничивается в диапазоне [0, 5]
     * @note Метод изменяет переданную карточку (неконстантная ссылка)
     * @note Алгоритм соответствует оригинальной спецификации SM2
     *
     * @throws Ничего не выбрасывает (noexcept)
     */
    static void updateCard(Card& card, int grade) noexcept;

    /**
     * @brief Получить карточки, готовые к повторению
     *
     * Фильтрует карточки в колоде, оставляя только те, которые
     * должны быть повторены на текущую дату.
     *
     * Критерии отбора:
     * 1. Дата nextReview наступила или прошла (nextReview <= now)
     * 2. Дата nextReview невалидна (пустая QDateTime)
     *
     * @param deck Колода для фильтрации (не модифицируется)
     * @return QList<Card> Список карточек для повторения
     *
     * @note Возвращает копию карточек, оригинальная колода не изменяется
     * @note Сложность: O(n), где n - количество карточек в колоде
     * @note Использует системное время (QDateTime::currentDateTime())
     *
     * @throws Ничего не выбрасывает (noexcept)
     */
    static QList<Card> getDueCards(const Deck& deck) noexcept;

    /**
     * @brief Получить количество карточек для повторения
     *
     * Более эффективная версия getDueCards(), которая только подсчитывает
     * карточки без создания их копий.
     *
     * @param deck Колода для проверки
     * @return int Количество карточек, готовых к повторению
     *
     * @note Всегда возвращает то же значение, что и getDueCards(deck).size()
     * @note Сложность: O(n), но без аллокаций для копий карточек
     *
     * @throws Ничего не выбрасывает (noexcept)
     */
    static int getDueCount(const Deck& deck) noexcept;

    /**
     * @brief Проверить, готова ли карточка к повторению
     *
     * Вспомогательный метод для проверки отдельной карточки.
     *
     * @param card Карточка для проверки
     * @return true если карточка готова к повторению, false в противном случае
     *
     * @note Использует текущее системное время для сравнения
     * @note Считает невалидные даты (QDateTime()) готовыми к повторению
     *
     * @throws Ничего не выбрасывает (noexcept)
     */
    static bool isCardDue(const Card& card) noexcept;

    /**
     * @brief Получить следующий интервал повторения по алгоритму SM2
     *
     * Расчет интервала без изменения состояния карточки.
     * Полезно для предварительного просмотра или симуляций.
     *
     * @param currentInterval Текущий интервал в днях
     * @param repetitions Количество успешных повторений
     * @param easyFactor Текущий фактор легкости (EF)
     * @param grade Оценка ответа (0-5)
     * @return int Новый интервал в днях
     *
     * @note Grade должна быть в диапазоне [0, 5]
     * @note Не изменяет переданные параметры
     *
     * @throws Ничего не выбрасывает (noexcept)
     */
    static int calculateNextInterval(int currentInterval, int repetitions,
                                     float easyFactor, int grade) noexcept;

    /**
     * @brief Рассчитать новый Easy Factor по алгоритму SM2
     *
     * Расчет EF без изменения состояния карточки.
     *
     * @param currentEasyFactor Текущий фактор легкости
     * @param grade Оценка ответа (0-5)
     * @return float Новый фактор легкости (ограниченный [1.3, 2.5])
     *
     * @note Результат всегда в диапазоне [1.3, 2.5]
     * @note Grade должна быть в диапазоне [0, 5]
     *
     * @throws Ничего не выбрасывает (noexcept)
     */
    static float calculateNextEasyFactor(float currentEasyFactor, int grade) noexcept;
};

